<div id="widget-canciones">
    <h2>Ofertas</h2>
    <div id="tablaCuerpo">

    </div>
</div>
<script>
    window.history.pushState("", "", "/cliente.html?w=conversaciones");

    var ofertas;

    function cargarConversaciones() {
        $.ajax({
            url: URLbase + "/conversaciones/",
            type: "GET",
            dataType: 'json',
            data: {},
            headers: {
                "token": Cookies.get('token')
            },
            success: function (respuesta) {
                actualizarTabla(respuesta);
            },
            error: function (error) {
                alert('Error al listar conversaciones');
                Cookies.remove('token');
                $("#contenedor-principal").load("widget-login.html");
            }
        });
    }

    function actualizarTabla(conversaciones) {
        $("#tablaCuerpo").empty(); // Vaciar la tabla
        for (i = 0; i < conversaciones.length; i++) {
            if (conversaciones[i].emisor === Cookies.get('email'))
                $("#tablaCuerpo").append(
                    "<a onclick = mensajes('" + conversaciones[i].oferta._id + "','" + conversaciones[i].receptor + "','" + conversaciones[i].emisor + "')>" +
                    "<div id='conversacion' class='form-group'>" +
                    "<div>" +
                    "<td id = 'propietarioChat'>" + conversaciones[i].receptor.toUpperCase() + "</td>" +
                    "</div>" +
                    "<div>" +
                    "<td>" + conversaciones[i].oferta.nombre + "</td>" +
                    "</div>" +
                    "<div class='row text-right'>" +
                    "<a id='eliminarConver' class='btn btn-danger' onclick=eliminarConversacion('" + conversaciones[i].oferta._id + "','" + conversaciones[i].receptor + "','" + conversaciones[i].emisor + "')>Eliminar</a>" +
                    "</div>" +
                    "</div>" +
                    "</a>");
            else
                $("#tablaCuerpo").append(
                    "<a onclick = mensajes('" + conversaciones[i].oferta._id + "','" + conversaciones[i].emisor + "','" + conversaciones[i].receptor + "')>" +
                    "<div id='conversacion' class='form-group'>" +
                    "<div>" +
                    "<td id = 'propietarioChat'>" + conversaciones[i].emisor.toUpperCase() + "</td>" +
                    "</div>" +
                    "<div>" +
                    "<td>" + conversaciones[i].oferta.nombre + "</td>" +
                    "</div>" +
                    "<div class='row text-right'>" +
                    "<a id='eliminarConver' class='btn btn-danger' onclick=eliminarConversacion('" + conversaciones[i].oferta._id + "','" + conversaciones[i].emisor + "','" + conversaciones[i].receptor + "')>Eliminar</a>" +
                    "</div>" +
                    "</div>" +
                    "</a>");
        }

    }


    function mensajes(_id, receptor, emisor) {
        idOfertaSeleccionada = _id;
        Cookies.set("receptor", receptor);
        Cookies.set("emisor", emisor);
        $("#contenedor-principal").load("widget-mensajes.html");
    }

    function eliminarConversacion(_id, propietario, comprador) {
        $.ajax({
            url: URLbase + "/conversaciones/eliminar/" + _id + "/" + propietario + "/" + comprador,
            type: "GET",
            data: {},
            dataType: 'json',
            headers: {
                "token": Cookies.get('token')
            },
            success: function (respuesta) {
                console.log("Algo esta haciendo - 000000000000000000000000000000000000000000000000000000000000000000000");
                $("#contenedor-principal").load("widget-conversaciones.html");
            },
            error: function (error) {
                console.log(error.toString());
                alert('Error al listar conversaciones');
                Cookies.remove('token');
                $("#contenedor-principal").load("widget-login.html");
            }
        });
        $("#contenedor-principal").load("widget-conversaciones.html");
    }

    function marcarComoLeido() {
        $.ajax({
            url: URLbase + "/mensaje/leido/:id",
            type: "GET",
            data: {},
            dataType: 'json',
            headers: {
                "token": Cookies.get('token')
            },
            success: function (respuesta) {
            },
            error: function (error) {
                console.log(error.toString());
                alert('Error al marcar como le√≠do');
            }
        })
    }


    cargarConversaciones();
</script>